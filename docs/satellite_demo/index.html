<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>VersaTiles Satellite Demo</title>
	<meta name="description" content="Try the beta version of our free satellite map tiles.">
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

	<!-- Social / Open Graph -->
	<meta property="og:type" content="website">
	<meta property="og:site_name" content="VersaTiles">
	<meta property="og:title" content="VersaTiles Satellite Demo">
	<meta property="og:description" content="Try the beta version of our free satellite map tiles.">
	<meta property="og:image" content="https://versatiles-satellite.b-cdn.net/preview.jpg">
	<meta property="og:image:alt" content="Satellite view of Europe with the VersaTiles logo">

	<!-- Twitter -->
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="VersaTiles Satellite Demo">
	<meta name="twitter:description" content="Try the beta version of our free satellite map tiles.">
	<meta name="twitter:image" content="https://versatiles-satellite.b-cdn.net/preview.jpg">
	<meta name="twitter:image:alt" content="Satellite view of Europe with the VersaTiles logo">

	<!-- Optional UI color -->
	<meta name="theme-color" content="#111111">

	<link rel="icon" type="image/png" href="https://versatiles-satellite.b-cdn.net/assets/images/versatiles-logo.png">

	<script src="https://versatiles-satellite.b-cdn.net/assets/lib/maplibre-gl/maplibre-gl.js"></script>
	<link href="https://versatiles-satellite.b-cdn.net/assets/lib/maplibre-gl/maplibre-gl.css" rel="stylesheet">

	<script src="https://versatiles-satellite.b-cdn.net/assets/lib/versatiles-style/versatiles-style.js"></script>

	<style>
		body {
			margin: 0;
			padding: 0;
		}

		#map {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 100%;
		}

		#banner {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			height: auto;
			background-color: rgba(255, 255, 255, 0.8);
			padding: 6px 12px 6px 6px;
			font-family: sans-serif;
			font-size: 1rem;
			display: flex;
			flex-direction: row;
			align-items: center;
			column-gap: 1em;
			backdrop-filter: blur(4px);
			z-index: 10000;
		}

		#banner p {
			margin: 0.3em 0;
			padding: 0;
		}

		#banner #text {
			padding-right: 1em;
		}

		#banner #btn_close {
			position: absolute;
			top: 0.4em;
			right: 0.4em;
			font-size: 16px;
			cursor: pointer;
		}

		a {
			color: inherit !important;
		}

		.maplibregl-popup-content {
			line-height: 1.4em;
			user-select: none;
			pointer-events: none;
		}

		.maplibregl-popup-content a {
			outline: none;
		}

		.maplibregl-popup-content .stars {
			color: black;
		}

		.maplibregl-popup-content .stars i {
			opacity: 0.3;
			font-style: normal;
		}
	</style>
	<script>
		function close_banner() {
			console.log('close');
			document.getElementById('text').style.display = 'none';
			document.getElementById('btn_close').style.display = 'none';
			const banner = document.getElementById('banner');
			banner.style.backdropFilter = 'none';
			banner.style.background = 'none';
		}
	</script>
</head>

<body style="margin:0;height:100%;">
	<div id="map" class="maplibregl-compact"></div>
	<div id="banner">
		<div>
			<a href="https://versatiles.org"><img src="https://tiles.versatiles.org/assets/images/versatiles-logo.png"
					alt="VersaTiles" width="32"></a>
		</div>
		<div id="text">
			<p>This demo overlays orthophotos on top of data from <a href="https://s2gm.land.copernicus.eu/">Sentinel-2</a> and <a
					href="https://visibleearth.nasa.gov/collection/1484/blue-marble">Blue Marble</a>.</p>
			<p>Zoom in to explore details; zoom out to see metadata.</p>
			<p>It is built and served with <a href="https://versatiles.org">VersaTiles</a> (<a
					href="https://versatiles.org">Website</a>, <a href="https://github.com/versatiles-org">GitHub</a>). Once
				finished, the tiles will be freely available at <a
					href="https://download.versatiles.org/">download.versatiles.org</a>.</p>
			<p>Learn more or report <a href="https://github.com/versatiles-org/orthophotos/issues">issues</a> in the <a
					href="https://github.com/versatiles-org/orthophotos">GitHub repository</a>.</p>
			<p>
				<b>Please help to cover the infrastructure costs by becoming a <a
						href="https://github.com/sponsors/MichaelKreil">GitHub Sponsor</a> or an <a
						href="https://opencollective.com/versatiles">Open Collective backer</a>.</b><br>
				The high-performance server I rent to process these terabytes of image material alone costs me €500 per month.
			</p>
		</div>
		<div id="btn_close" onclick="close_banner()">&#x2715;</div>
	</div>
	<script>
		const style = VersaTilesStyle.graybeard({
			baseUrl: 'https://tiles.versatiles.org',
			colors: {
				label: '#000', // render all labels in black
			},
		});

		style.layers = style.layers.filter(l => l.id != 'background' && l.type != 'fill' && !/^(land|water|site|airport|tunnel)-/.test(l.id));

		style.layers.forEach(layer => {
			if (!layer.paint) return;
			if (layer.type == 'symbol') {
				if (layer.layout['text-font']) {
					layer.layout['text-font'] = ['noto_sans_bold'];
					layer.paint['text-color'] = '#fff';
					layer.paint['text-halo-color'] = '#000';
					if (layer.paint['text-halo-blur']) {
						layer.paint['text-halo-blur'] = 0;
					}
					if (layer.paint['text-halo-width']) {
						layer.paint['text-halo-width'] = 1;
					}
				}
			}
			if (layer.type == 'line') {
				let opacity = 0.2;
				let v = layer.paint['line-opacity'];
				if (!v) {
					v = opacity;
				} else if (typeof v == 'number') {
					v = v * opacity;
				} else if ('stops' in v) {
					v.stops = v.stops.map(s => [s[0], s[1] * opacity]);
				} else {
					console.log(v);
				}
				layer.paint['line-opacity'] = v;
			}
		});

		style.sources.orthophotos = {
			type: 'raster',
			tiles: ['https://versatiles-satellite.b-cdn.net/tiles/orthophotos/{z}/{x}/{y}'],
			tileSize: 512,
			attribution: '© VersaTiles',
			maxzoom: 17,
		};
		style.layers.unshift({
			id: 'orthophotos',
			type: 'raster',
			source: 'orthophotos',
			minzoom: 0,
		});

		const map = new maplibregl.Map({
			container: 'map',
			//bounds: [-23.213, 34.9, 45.112, 62.671],
			center: [10, 50],
			zoom: 4,
			maxZoom: 18,
			hash: true,
			maxPitch: 0,
			style,
			dragRotate: false,
			attributionControl: { compact: false },
		});

		map.addControl(new maplibregl.NavigationControl(), 'top-right');

		// load json file from url
		(async () => {
			const response = await fetch('https://versatiles-satellite.b-cdn.net/status.json');
			const regions = await response.json();
			const featuresRegions = [];
			const featuresData = [];
			const regionsById = new Map();
			for (const region of regions) {
				if (region.status.status != 'success') continue;

				const id = region.id;
				featuresRegions.push(region.region);
				regionsById.set(id, region);
				for (const entry of region.status.entries) {
					if (!entry.versaTilesExists) continue;
					const name = entry.name;
					const featureData = entry.geoJSON;
					featureData.properties = { id, name };
					featuresData.push(featureData);
				}
			}
			map.addSource('regions', {
				type: 'geojson',
				data: { type: 'FeatureCollection', features: featuresRegions },

			});
			map.addSource('mapdata', {
				type: 'geojson',
				data: { type: 'FeatureCollection', features: featuresData },

			});
			map.addLayer({
				id: 'regions',
				type: 'fill',
				source: 'regions',
				maxzoom: 3.9,
				paint: {
					'fill-color': '#f00',
					'fill-opacity': 0.5,
				},
			});
			map.addLayer({
				id: 'mapdata',
				type: 'fill',
				source: 'mapdata',
				maxzoom: 3.9,
				paint: {
					'fill-color': '#66f',
					'fill-opacity': 0.5,
				},
			});
			const popup = new maplibregl.Popup({
				maxWidth: '300px',
				closeButton: false,
				closeOnClick: false
			});

			const canvas = map.getCanvas();
			map.on('mousemove', 'regions', (e) => {
				const features = e.features;
				let cursor = '';
				const feature = features[0];
				if (feature) {
					const id = feature.properties.id;
					const entry = regionsById.get(id);
					if (entry) {
						const { status, region, id } = entry;
						const stars = [0, 1, 2, 3, 4].map(i => i < status.rating ? '★' : '<i>★</i>').join('');
						const description = [
							`<b>Region: ${region.properties.name}</b>`,
							`<b>Rating:</b> <span class="stars">${stars}</span>`,
							`<b>Problems:</b> ${status.notes.length}`,
							`<b>Source:</b> <a href="${status.creator.url}" tabindex="-1">${status.creator.name}</a>`,
							`<b>License:</b> <a href="${status.license.url}" tabindex="-1">${status.license.name}</a>`,
						].join('<br>');
						popup.setLngLat(e.lngLat).setHTML(description).addTo(map);
						cursor = 'pointer';
					}
				}
				canvas.style.cursor = cursor;
			});
			map.on('mouseout', 'regions', (e) => {
				canvas.style.cursor = '';
				popup.remove();
			});
			map.on('mouseleave', 'regions', (e) => {
				canvas.style.cursor = '';
				popup.remove();
			});
		})();
	</script>
</body>

</html>